# CryptoVault Architecture

## Module Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CryptoVault                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      Integration Layer                               │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │                    event_logger.py                           │    │   │
│  │  │  • SecurityEvent logging                                     │    │   │
│  │  │  • Blockchain-based audit trail                              │    │   │
│  │  │  • Privacy-preserving user hashes                            │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      Application Modules                             │   │
│  │                                                                      │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │    │
│  │  │     Auth     │  │   Messaging  │  │    Files     │  │Blockchain│ │    │
│  │  │              │  │              │  │              │  │          │ │    │
│  │  │ registration │  │secure_channel│  │ file_crypto  │  │  ledger  │ │    │
│  │  │    login     │  │              │  │              │  │          │ │    │
│  │  │    totp      │  │              │  │              │  │          │ │    │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘ │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│            │                  │                  │               │           │
│            ▼                  ▼                  ▼               ▼           │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      Core Crypto Layer                               │    │
│  │                                                                      │    │
│  │  ┌──────────┐  ┌──────────┐  ┌────────────────┐  ┌──────────────┐   │    │
│  │  │  sha256  │  │  merkle  │  │aes_key_schedule│  │ lfsr_cipher  │   │    │
│  │  └──────────┘  └──────────┘  └────────────────┘  └──────────────┘   │    │
│  │                                                                      │    │
│  │  ┌──────────────────────────────────────────────────────────────┐   │    │
│  │  │                        rsa_math                               │   │    │
│  │  │  mod_exp, Miller-Rabin, generate_prime, gcd, mod_inverse      │   │    │
│  │  └──────────────────────────────────────────────────────────────┘   │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      External Libraries                              │    │
│  │                                                                      │    │
│  │  cryptography │ argon2-cffi │ pyotp │ bcrypt │ qrcode               │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Module Dependencies

```
                    ┌─────────────────┐
                    │  event_logger   │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
         ▼                   ▼                   ▼
   ┌───────────┐      ┌───────────┐      ┌───────────┐
   │   auth    │      │ messaging │      │   files   │
   └─────┬─────┘      └─────┬─────┘      └─────┬─────┘
         │                  │                  │
         │                  │                  │
         ▼                  ▼                  ▼
   ┌─────────────────────────────────────────────────┐
   │                  blockchain                      │
   │                   (ledger)                       │
   └───────────────────────┬─────────────────────────┘
                           │
                           ▼
   ┌─────────────────────────────────────────────────┐
   │                 core_crypto                      │
   │  sha256 │ merkle │ aes_key_schedule │ rsa_math  │
   └─────────────────────────────────────────────────┘
```

---

## Data Flow

### 1. User Authentication Flow

```
┌──────────┐     ┌──────────────────┐     ┌─────────────────┐     ┌────────────┐
│   User   │────▶│   Registration   │────▶│ PasswordHasher_ │────▶│  Argon2id  │
│          │     │                  │     │                 │     │   Hash     │
└──────────┘     └──────────────────┘     └─────────────────┘     └────────────┘
                          │                                              │
                          ▼                                              │
                 ┌──────────────────┐                                    │
                 │   User Store     │◀───────────────────────────────────┘
                 │  (password_hash) │
                 └────────┬─────────┘
                          │
                          ▼
┌──────────┐     ┌──────────────────┐     ┌─────────────────┐
│   User   │────▶│   LoginManager   │────▶│   RateLimiter   │
│ (login)  │     │                  │     │ (brute force    │
└──────────┘     └────────┬─────────┘     │  protection)    │
                          │               └─────────────────┘
                          ▼
                 ┌──────────────────┐     ┌─────────────────┐
                 │ SessionManager   │────▶│  HMAC-SHA256    │
                 │                  │     │  Session Token  │
                 └────────┬─────────┘     └─────────────────┘
                          │
                          ▼
                 ┌──────────────────┐     ┌─────────────────┐
                 │  TOTPGenerator   │────▶│   HOTP/TOTP     │
                 │  (2FA optional)  │     │   RFC 6238      │
                 └──────────────────┘     └─────────────────┘
```

### 2. Secure Messaging Flow

```
┌─────────┐                                              ┌─────────┐
│  Alice  │                                              │   Bob   │
└────┬────┘                                              └────┬────┘
     │                                                        │
     │  1. Generate KeyPair                                   │
     ▼                                                        ▼
┌─────────────┐                                        ┌─────────────┐
│  KeyPair    │                                        │  KeyPair    │
│ (ECDSA P256)│                                        │ (ECDSA P256)│
└──────┬──────┘                                        └──────┬──────┘
       │                                                      │
       │  2. Exchange public keys                             │
       │◀────────────────────────────────────────────────────▶│
       │                                                      │
       ▼                                                      ▼
┌─────────────┐                                        ┌─────────────┐
│SecureChannel│                                        │SecureChannel│
└──────┬──────┘                                        └──────┬──────┘
       │                                                      │
       │  3. ECDH Key Exchange                                │
       ▼                                                      ▼
┌─────────────────┐                                  ┌─────────────────┐
│ Shared Secret   │                                  │ Shared Secret   │
│ (32 bytes)      │                                  │ (32 bytes)      │
└────────┬────────┘                                  └────────┬────────┘
         │                                                    │
         │  4. HKDF Key Derivation                            │
         ▼                                                    ▼
┌─────────────────┐                                  ┌─────────────────┐
│  Session Key    │                                  │  Session Key    │
│  (AES-256)      │                                  │  (AES-256)      │
└────────┬────────┘                                  └────────┬────────┘
         │                                                    │
         │  5. Encrypt Message                                │
         ▼                                                    │
┌─────────────────┐                                           │
│   AES-256-GCM   │                                           │
│   + ECDSA Sign  │                                           │
└────────┬────────┘                                           │
         │                                                    │
         │  6. Send EncryptedMessage                          │
         │────────────────────────────────────────────────────▶
         │     (nonce, ciphertext, tag, signature)            │
                                                              ▼
                                                    ┌─────────────────┐
                                                    │ Verify Signature│
                                                    │  + AES Decrypt  │
                                                    └────────┬────────┘
                                                             │
                                                             ▼
                                                    ┌─────────────────┐
                                                    │   Plaintext     │
                                                    └─────────────────┘
```

### 3. File Encryption Flow

```
┌─────────────┐     ┌───────────────┐     ┌─────────────────┐
│  Plaintext  │     │   Password    │     │     PBKDF2      │
│    File     │     │               │────▶│  (100k iters)   │
└──────┬──────┘     └───────────────┘     └────────┬────────┘
       │                                           │
       │                                           ▼
       │                                  ┌─────────────────┐
       │                                  │   Master Key    │
       │                                  │   (256 bits)    │
       │                                  └────────┬────────┘
       │                                           │
       │                                           ▼
       │                                  ┌─────────────────┐
       │                                  │   Random FEK    │
       │                                  │ (File Enc Key)  │
       │                                  └────────┬────────┘
       │                                           │
       ▼                                           ▼
┌─────────────────────────────────────────────────────────────┐
│                      FileEncryptor                           │
│  ┌─────────────────┐    ┌─────────────────────────────────┐ │
│  │  Read Chunks    │───▶│  AES-256-GCM Encrypt (Stream)   │ │
│  │  (64KB blocks)  │    │  + HMAC Integrity               │ │
│  └─────────────────┘    └─────────────────────────────────┘ │
└──────────────────────────────────┬──────────────────────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │  Encrypted File │
                          │  ┌───────────┐  │
                          │  │  Header   │  │
                          │  │  (salt,   │  │
                          │  │   nonce,  │  │
                          │  │   enc_fek)│  │
                          │  ├───────────┤  │
                          │  │ Encrypted │  │
                          │  │   Data    │  │
                          │  ├───────────┤  │
                          │  │   HMAC    │  │
                          │  └───────────┘  │
                          └─────────────────┘
```

### 4. Blockchain Audit Logging Flow

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Security Events                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │  Login   │  │  TOTP    │  │  File    │  │ Message  │            │
│  │  Event   │  │  Event   │  │  Event   │  │  Event   │            │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘            │
│       │             │             │             │                   │
└───────┼─────────────┼─────────────┼─────────────┼───────────────────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         EventLogger                                  │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Privacy: user_id ──▶ SHA-256(user_id + salt) ──▶ user_hash │   │
│  └─────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Pending Transactions                          │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  [event1_json, event2_json, event3_json, ...]                │  │
│  └──────────────────────────────────────────────────────────────┘  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                │  mine_events()
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          Blockchain                                  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      MerkleTree                               │  │
│  │  tx1 ──┐                                                      │  │
│  │        ├──▶ H(tx1+tx2) ──┐                                   │  │
│  │  tx2 ──┘                 │                                    │  │
│  │                          ├──▶ Merkle Root                     │  │
│  │  tx3 ──┐                 │                                    │  │
│  │        ├──▶ H(tx3+tx4) ──┘                                   │  │
│  │  tx4 ──┘                                                      │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐│
│  │                    Proof of Work                                ││
│  │                                                                 ││
│  │  while True:                                                    ││
│  │      block_hash = SHA-256(header + nonce)                       ││
│  │      if block_hash < target:  # leading zeros                   ││
│  │          break                                                  ││
│  │      nonce += 1                                                 ││
│  └────────────────────────────────────────────────────────────────┘│
│                                                                      │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐         │
│  │ Genesis │───▶│ Block 1 │───▶│ Block 2 │───▶│ Block N │         │
│  │  Block  │    │         │    │         │    │         │         │
│  │         │    │prev_hash│    │prev_hash│    │prev_hash│         │
│  │  hash   │◀───│   ═     │◀───│   ═     │◀───│   ═     │         │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘         │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Security Architecture

### Cryptographic Primitives Used

| Component | Algorithm | Key Size | Purpose |
|-----------|-----------|----------|---------|
| Password Hashing | Argon2id | N/A | Secure password storage |
| Key Derivation | PBKDF2-SHA256 | 256-bit | File encryption key |
| Key Exchange | ECDH (P-256) | 256-bit | Shared secret agreement |
| Symmetric Encryption | AES-256-GCM | 256-bit | Data encryption + auth |
| Digital Signatures | ECDSA (P-256) | 256-bit | Message authentication |
| Hash Function | SHA-256 | 256-bit | Merkle tree, PoW, integrity |
| TOTP | HMAC-SHA1 | 160-bit | Two-factor authentication |

### Security Properties

1. **Confidentiality**: AES-256-GCM encryption for all sensitive data
2. **Integrity**: HMAC and GCM authentication tags
3. **Authentication**: Argon2id passwords + TOTP 2FA
4. **Non-repudiation**: ECDSA digital signatures
5. **Forward Secrecy**: Ephemeral ECDH key exchange
6. **Audit Trail**: Immutable blockchain logging

---

## Testing Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Test Suite                                  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                     Unit Tests                                │  │
│  │  test_core_crypto.py │ test_auth.py │ test_messaging.py      │  │
│  │  test_files.py │ test_blockchain.py                          │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                   Integration Tests                           │  │
│  │  test_integration.py                                          │  │
│  │  • Full auth workflow                                         │  │
│  │  • Secure messaging workflow                                  │  │
│  │  • File encryption workflow                                   │  │
│  │  • Blockchain event logging                                   │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                    Security Tests                             │  │
│  │  test_security.py                                             │  │
│  │  • Wrong TOTP codes                                           │  │
│  │  • Modified ciphertext detection                              │  │
│  │  • Invalid Merkle proofs                                      │  │
│  │  • Forged signature rejection                                 │  │
│  │  • Brute force prevention                                     │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```
